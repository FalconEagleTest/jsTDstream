name: Build Portable Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      description:
        description: 'Release description'
        required: false

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: arm64
            os: android64
            pkg_target: node16-linux-arm64
          - target: arm
            os: android32
            pkg_target: node16-linux-armv7

    steps:
    - uses: actions/checkout@v4
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 16

    - name: Install dependencies
      run: |
        npm ci --ignore-scripts
        npm install --save-dev pkg

    - name: Build Binary (ARM64)
      if: matrix.target == 'arm64'
      run: |
        npx pkg . \
          --target ${{ matrix.pkg_target }} \
          --output telegram-file-server-${{ matrix.os }} \
          --public \
          --no-bytecode

    - name: Build Binary (ARM32)
      if: matrix.target == 'arm'
      run: |
        NODE_VERSION="v16.20.2"
        mkdir -p dist
        
        # Download ARM32 binary
        wget -q https://unofficial-builds.nodejs.org/download/release/${NODE_VERSION}/node-${NODE_VERSION}-linux-armv7l.tar.gz || \
        wget -q https://nodejs.org/download/release/${NODE_VERSION}/node-${NODE_VERSION}-linux-armv7l.tar.gz
        
        tar -xzf node-${NODE_VERSION}-linux-armv7l.tar.gz
        
        # Create directory structure
        mkdir -p package
        cp -r src package/
        cp -r node_modules package/
        cp package.json package/
        
        # Copy Node.js binary
        cp node-${NODE_VERSION}-linux-armv7l/bin/node package/telegram-file-server-${{ matrix.os }}
        chmod +x package/telegram-file-server-${{ matrix.os }}
        
        # Create startup script
        cat > package/start.sh << 'EOL'
        #!/bin/sh
        DIR=$(dirname "$0")
        export NODE_PATH=$DIR/node_modules
        exec $DIR/telegram-file-server-${{ matrix.os }} $DIR/src/index.js "$@"
        EOL
        
        chmod +x package/start.sh
        
        # Create archive
        cd package
        tar -czf ../telegram-file-server-${{ matrix.os }}.tar.gz *
        cd ..
        
        # Move binary out for separate upload
        mv package/telegram-file-server-${{ matrix.os }} .

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        files: |
          telegram-file-server-${{ matrix.os }}*
          telegram-file-server-${{ matrix.os }}.tar.gz
        tag_name: v${{ inputs.version }}-${{ matrix.os }}-${{ steps.date.outputs.date }}
        name: Telegram File Server ${{ matrix.os }} v${{ inputs.version }}
        body: |
          Version: ${{ inputs.version }}
          Platform: ${{ matrix.os }}
          Architecture: ${{ matrix.target }}
          Build Date: ${{ steps.date.outputs.date }}
          
          ${{ inputs.description }}
          
          ### Notes
          - This build is for Linux ${{ matrix.target }}
          - For use on Android with root access
          
          ### Installation (ARM32)
          1. Extract the tar.gz file
          2. Run ./start.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: telegram-file-server-${{ matrix.os }}
        path: |
          telegram-file-server-${{ matrix.os }}*
          telegram-file-server-${{ matrix.os }}.tar.gz
        compression-level: 0
